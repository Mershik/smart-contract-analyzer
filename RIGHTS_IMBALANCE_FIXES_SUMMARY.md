# Исправления анализа дисбаланса прав

## Проблемы, которые были решены:

### 1. **Ошибка в классификации штрафов**
- **Проблема**: Штраф в 2000 рублей классифицировался как "пеня 2000%"
- **Причина**: Отсутствовала функция `extractFinancialValue`, неправильная логика анализа
- **Решение**: 
  - Создана новая функция `extractPenaltyInfo()` для корректного извлечения информации о штрафах/неустойках
  - Исправлена логика анализа ответственности в `analyzeRightsImbalanceProgrammatically()`
  - Теперь штрафы в рублях и проценты обрабатываются отдельно

### 2. **Избыточная информация в UI**
- **Проблема**: Отображались лишние данные:
  - "2 дисбалансов" в отдельной строке
  - Общий подсчет прав сторон
  - Подсчет в каждой категории ("Покупатель: 1, Поставщик: 6")
  - Общая рекомендация
- **Решение**: 
  - Заголовок изменен на "Дисбаланс прав сторон (2)"
  - Убрана общая статистика прав
  - Убран подсчет прав в каждой категории
  - Убрана общая рекомендация

### 3. **Улучшена точность анализа**
- **Добавлена функция `extractPenaltyInfo()`** для корректного извлечения:
  - Штрафов в рублях (например, "штраф 2000 рублей")
  - Неустоек в процентах (например, "неустойка 0.1%")
  - Пени в процентах (например, "пеня 1%")
- **Исправлена логика определения дисбаланса**:
  - Убрана некорректная математическая логика сравнения
  - Добавлена проверка на количественный дисбаланс
  - Улучшены описания дисбалансов

## Внесенные изменения:

### В файле `client/src/lib/gemini.ts`:

#### Добавлена функция `extractPenaltyInfo()`:
```typescript
function extractPenaltyInfo(text: string): string | null {
  // Ищем штрафы в рублях
  const rubleMatch = text.match(/штраф[а-я]*\s+в\s+размере\s+(\d+(?:\s?\d+)*)\s*рубл/i);
  if (rubleMatch) {
    const amount = rubleMatch[1].replace(/\s/g, '');
    return `штраф ${amount} рублей`;
  }
  
  // Ищем неустойки в процентах
  const percentMatch = text.match(/(?:неустойк[а-яё]*|пен[яюё])\s+в\s+размере\s+(\d+(?:[.,]\d+)?)\s*%/i);
  if (percentMatch) {
    return `неустойка ${percentMatch[1]}%`;
  }
  
  // И т.д.
}
```

#### Исправлена функция анализа ответственности:
- Заменена несуществующая `extractFinancialValue()` на `extractPenaltyInfo()`
- Исправлена логика определения дисбаланса
- Улучшены описания с конкретными примерами

### В файле `client/src/components/rights-imbalance-results.tsx`:

#### Упрощен интерфейс:
- Заголовок: `"Дисбаланс прав сторон (2)"` вместо отдельного счетчика
- Убрана общая статистика прав
- Убран подсчет прав в каждой категории
- Убрана общая рекомендация

## Результат:

### ✅ **Корректная классификация штрафов**
- Штраф 2000 рублей теперь правильно отображается как "штраф 2000 рублей"
- Неустойки в процентах корректно обрабатываются

### ✅ **Чистый интерфейс**
- Убрана избыточная информация
- Фокус на конкретных дисбалансах и рекомендациях
- Более читаемый и структурированный вид

### ✅ **Точный анализ**
- Исправлена логика определения дисбалансов
- Добавлены конкретные примеры в описаниях
- Улучшена обработка различных типов санкций

## Пример результата после исправлений:

```
Дисбаланс прав сторон (2)

Права взыскания штрафов/неустоек
КРИТИЧНО

Обнаружен критический дисбаланс ответственности: санкции, которые может применить Поставщик (например, штраф 2000 рублей), значительно превышают санкции, доступные Покупателю (например, неустойка 0.1%).

Рекомендация: Рекомендуется пересмотреть размеры и основания для неустоек, чтобы обеспечить соразмерность финансовой ответственности сторон.

Права Покупателя (1)
5.2. За несвоевременную поставку Товара...

Права Поставщика (4)
5.3. При несоблюдении согласованного в Спецификации срока платежей...
5.4. За простой автотранспорта Поставщика в ожидании разгрузки...
```
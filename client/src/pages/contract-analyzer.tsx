import { useState, useRef, useEffect } from "react";
import { File, ChartLine } from "lucide-react";
import { ContractInput } from "@/components/contract-input";
import { RequirementsInput } from "@/components/requirements-input";
import { RiskInput } from "@/components/risk-input";
import { AnalysisResults } from "@/components/analysis-results";
import { AnalysisProgress } from "@/components/analysis-progress";
import { StructuralAnalysisComponent } from "@/components/structural-analysis";
import { Button } from "@/components/ui/button";
import { useGeminiAnalysis } from "@/hooks/use-gemini-analysis";
import { exportToDocx } from "@/lib/docx-export";
import type { ContractParagraph, Contradiction, RightsImbalance } from "@shared/schema";
import { ContradictionsResults } from "@/components/contradictions-results";
import { RightsImbalanceResults } from "@/components/rights-imbalance-results";
import { AnalysisPerspective, PerspectiveSelector } from "@/components/perspective-selector";
import { TableOfContents } from "@/components/table-of-contents";
import { FloatingFilters } from "@/components/floating-filters";
import { QualityFeedback } from "@/components/quality-feedback";

// ... (Ваши константы buyerChecklist, buyerRisks, и т.д. остаются без изменений) ...
const buyerChecklist = `•	Определение товара: Порядок согласования наименования, количества, ассортимента и цены товара определяется через Заявки Покупателя, подтверждаемые Счетами/Спецификациями Поставщика.
•	Обязательность Заявки: Установлен обязательный срок для Поставщика на рассмотрение и акцепт Заявки Покупателя (рекомендуется: 2-3 рабочих дня), а также последствия игнорирования Заявки (например, считается отказом).
•	Сроки поставки: Установлены конкретные сроки поставки или четкий и однозначный механизм их определения для каждой партии (например, X дней с момента оплаты счета).
•	Базис поставки: Четко определен один из вариантов: доставка на склад Покупателя (адрес указан) или самовывоз со склада Поставщика (адрес указан).
•	Расходы на логистику: Явно прописано распределение расходов на погрузку/разгрузку 
•	Момент поставки: Датой поставки считается дата фактической приемки товара на складе Покупателя и подписания товаросопроводительных документов (ТОРГ-12/УПД).
•	Тара и упаковка: Установлены требования к таре и упаковке, обеспечивающие сохранность товара, и предусмотрена ответственность Поставщика за повреждение товара из-за ненадлежащей упаковки.
•	Сопроводительные документы: Поставщик обязан вместе с товаром предоставить полный комплект документов (сертификаты/декларации соответствия, паспорта, инструкции на русском языке, гарантийные талоны).
•	Сроки приемки: Установлен разумный срок для приемки товара по количеству и явным недостаткам (рекомендуется: не менее 5-10 рабочих дней).
•	Скрытые недостатки: Претензии по скрытым недостаткам, обнаруженным в процессе эксплуатации, могут быть предъявлены в течение всего гарантийного срока (а если он не установлен – в течение 2-х лет).
•	Порядок фиксации недостатков: Установлен четкий порядок действий при обнаружении брака: срок уведомления Поставщика (3-5 раб. дней), срок для прибытия его представителя (3-5 раб. дней), и право Покупателя составить акт в одностороннем порядке в случае неявки представителя.
•	Фиксация цены: Цена на уже согласованную партию товара является твердой и не подлежит изменению. Изменение цен на будущие партии возможно только по письменному соглашению сторон с предварительным уведомлением (не менее 14-30 дней).
•	Исключение процентов: Указано, что отсрочка/рассрочка платежа не является коммерческим кредитом, и проценты по ст. 317.1 ГК РФ не начисляются.
•	Момент оплаты: Обязанность Покупателя по оплате считается исполненной в момент списания денежных средств с корреспондентского счета банка Покупателя.
•	Неустойка за просрочку поставки: Установлена неустойка (пеня) за нарушение срока поставки (рекомендуется: не менее 0.2% от стоимости не поставленного в срок товара за каждый день просрочки).
•	Права при поставке некачественного товара: Покупателю предоставлен полный спектр прав, предусмотренных ст. 475 ГК РФ: право требовать по своему выбору замены, уценки, безвозмездного устранения недостатков, возмещения своих расходов на их устранение либо полного возврата денег.
•	Срок устранения недостатков: Установлен короткий срок на замену некачественного товара (рекомендуется: 5-10 банковских дней).
•	Неустойка за неисполнение требований по качеству: Установлена неустойка (пеня) за просрочку замены/возврата денег/устранения недостатков некачественного товара (рекомендуется: не менее 0.2% в день).
•	Возмещение убытков: Прямо прописано, что Поставщик обязан возместить Покупателю все убытки, причиненные неисполнением договора, сверх неустойки (штрафные санкции носят штрафной, а не зачетный характер).
•	Переход рисков: Право собственности и риск случайной гибели/повреждения товара переходят к Покупателю в момент фактической приемки товара и подписания документов.
•	Заверения об обстоятельствах (ст. 431.2 ГК РФ): Поставщик гарантирует, что товар принадлежит ему на праве собственности, свободен от прав третьих лиц, не находится в залоге или под арестом, а также что сам Поставщик является добросовестным налогоплательщиком.
•	Право на одностороннее расторжение: Предусмотрено право Покупателя в одностороннем внесудебном порядке отказаться от договора в случае существенной или неоднократной просрочки поставки, поставки некачественного товара и/или введения в отношении Поставщика процедуры банкротства.
•	Претензионный порядок: Предусмотрен обязательный досудебный претензионный порядок с разумным сроком рассмотрения претензии (10-15 календарных дней).
•	Подсудность: Споры рассматриваются в Арбитражном суде по месту нахождения Покупателя.
•	Электронный документооборот: Документы (договор, приложения, заявки, счета), переданные по электронной почте, признаются имеющими юридическую силу.
`;
const buyerRisks = `Цена и ответственность
⚠️ Право поставщика в одностороннем порядке менять цену или сроки поставки.
⚠️ Ограничение ответственности поставщика суммой договора или партии товара.
⚠️ Исключение ответственности поставщика за упущенную выгоду и косвенные убытки.
⚠️ Отсутствие или низкий размер неустойки поставщика за срыв сроков или поставку брака.
⚠️ Высокие штрафы для покупателя за просрочку оплаты или приемки.
⚠️ Отсрочка платежа квалифицируется как коммерческий кредит (риск начисления процентов).
Поставка, приемка и качество
⚠️ Переход рисков на товар до его фактической приемки покупателем.
⚠️ Переход права собственности на товар только после 100% оплаты.
⚠️ Необоснованно короткие сроки для приемки товара и предъявления претензий.
⚠️ Невозможность составления одностороннего акта о недостатках товара.
⚠️ Возложение расходов на экспертизу брака по умолчанию на покупателя.
⚠️ Отсутствие обязанности поставщика передавать сертификаты и паспорта на товар.
Юридические и процедурные риски
⚠️ Подсудность споров по месту нахождения поставщика.
⚠️ Право поставщика приостанавливать поставки при любой, даже незначительной, задолженности.
⚠️ Отсутствие гарантий, что товар свободен от прав третьих лиц (не в залоге, не под арестом).
⚠️ Отсутствие обязательного срока ответа поставщика на заявку покупателя.
⚠️ Момент оплаты — зачисление на счет поставщика (увеличивает период "заморозки" средств).`;

// Требования и риски для ПОСТАВЩИКА
const supplierChecklist = `•	Заявка Покупателя становится обязательной только после письменного подтверждения Поставщиком.
•	Предусмотрена предоплата за товар.
•	Обязанность по оплате считается исполненной в момент зачисления денег на счет Поставщика.
•	Установлена неустойка за просрочку оплаты Покупателем.
•	Есть право Поставщика на пересмотр цены при изменении рыночных условий.
•	Право собственности и риски переходят к Покупателю на складе Поставщика или в момент передачи первому перевозчику.
•	Установлен короткий срок приемки товара (2-5 рабочих дней).
•	Если Покупатель не предъявил претензию в установленный срок, товар считается принятым.
•	Односторонний акт Покупателя о недостатках не имеет безусловной силы; для фиксации брака требуется участие представителя Поставщика или эксперта.
•	Общая ответственность Поставщика по договору ограничена определенной суммой (например, 10% от цены договора).
•	Установлено, что неустойка является зачетной (покрывает убытки, а не взыскивается сверх них).
•	Ответственность Поставщика за упущенную выгоду Покупателя исключена.
•	Право Покупателя на односторонний отказ от договора ограничено только существенными нарушениями.
•	Споры рассматриваются в Арбитражном суде по месту нахождения Поставщика.
•	Документы, переданные по электронной почте, имеют юридическую силу, но с обязательным последующим обменом оригиналами.
`;

const supplierRisks = `⚠️  Предоплата менее 30% от суммы договора.
⚠️ Невозможность изменения цены договора.
⚠️ Момент оплаты — списание средств со счета покупателя.
⚠️ Наличие «налоговой оговорки», перекладывающей риски покупателя на Поставщика.
⚠️ Неограниченная материальная ответственность Поставщика.
⚠️ Штрафные санкции более 1% в день за просрочку.
⚠️ Обязательство возмещения всех косвенных убытков и упущенной выгоды.
⚠️ Переход права собственности и рисков в момент приемки на складе покупателя.
⚠️ Длительные или неопределенные («разумные») сроки приемки товара.
⚠️ Право покупателя составлять акт о недостатках в одностороннем порядке.
⚠️ Отсутствие разделения претензий на явные и скрытые недостатки.
⚠️ Длительные сроки гарантийных обязательств (более 24 месяцев).
⚠️ Запрет на частичные поставки без согласия покупателя.
⚠️ Право покупателя на одностороннее расторжение без компенсаций Поставщику.
⚠️ Обязательство поставки в любых обстоятельствах (невыгодная редакция форс-мажора).
⚠️ Подсудность споров по месту нахождения покупателя.
⚠️ Заявки покупателя не являются обязательными к выкупу.`;

const defaultContractText = `
1.	Предмет Договора

1.1.	Поставщик обязуется осуществить поставку сыпучих строительных материалов (далее – Товар) на условиях, предусмотренных настоящим Договором, а Покупатель обязуется принять и оплатить Товар.
1.2.	Наименование, ассортимент, количество и цена Товара, сроки поставки, наименование грузополучателя (при наличии), адрес места назначения доставки Товара (место поставки Товара), условия оплаты и иные условия поставки определяются на основании подписанных Сторонами Спецификаций, являющихся неотъемлемой частью настоящего Договора.
1.3.	В случае расхождений между условиями Договора и условиями Спецификации применяются условия, согласованные в Спецификации.

2.	Порядок поставки

2.1.	Оформление Спецификации инициируется Поставщиком по заявке Покупателя. Заявка направляется Поставщику в произвольной письменной форме по электронной почте или телефону (в т.ч. с помощью мессенджеров), с указанием наименования Товара, необходимого количества и предполагаемых сроков поставки, иных пожеланий Покупателя. Вопросы, связанные с подготовкой Спецификации, могут согласовываться в рабочем порядке, в т.ч. по телефону. На основе заявки Покупателя Поставщик готовит Спецификацию, которую направляет Покупателю для подписания и оформления. Подписание Спецификации налагает на Стороны взаимные обязательства, подлежащие исполнению.
2.2.	Если иное не предусмотрено Спецификацией, то поставка Товара организуется Поставщиком до места назначения, указанного Покупателем.
2.3.	Товар доставляется Покупателю или грузополучателю, указанному Покупателем, автомобильным транспортом.
2.4.	Количество (масса) Товара определяется взвешиванием гружёного Товаром транспортного средства на весах, установленных на карьере. Количество Товара указывается в товарно- транспортной накладной или транспортной накладной.
2.5.	На каждое автотранспортное средство, задействованное в доставке Товара до Покупателя/грузополучателя оформляется товарно-транспортная накладная или транспортная накладная, на усмотрение Поставщика (далее по тексту «ТН», «транспортная накладная»).
2.6.	Поставка Товара осуществляется Поставщиком путем доставки Товара на склад/до места назначения Покупателя/грузополучателя.
Датой поставки считается дата доставки Товара до места назначения Покупателя/грузополучателя и подписания представителем Покупателя/грузополучателя транспортной накладной.
В целях реализации настоящего пункта Стороны устанавливают, что лицо, осуществляющее приёмку Товара в месте нахождения Покупателя/грузополучателя, является лицом, имеющим все необходимые полномочия для приёмки Товара и подписания транспортной накладной.
2.7.	Право собственности на Товар, поставляемый по настоящему Договору, а также риск случайной гибели или повреждения Товара переходят от Поставщика к Покупателю в момент
 
подписания уполномоченным представителем Покупателя/грузополучателя транспортной накладной, подтверждающей приемку Товара. Подписание транспортной накладной подтверждает приемку Покупателем Товара по количеству, качеству и ассортименту.
2.8.	Покупатель обязан создать условия для правильной и своевременной приемки Товара, в том числе устройство и содержание в надлежащем состоянии подъездных дорог к месту разгрузки Товара, подготовка места разгрузки (площадки) Товара для его незамедлительной выгрузки, во избежание простоя автотранспортных средств Поставщика.
2.9.	Еженедельно, если иное не согласовано Сторонами в Спецификации, Поставщик предоставляет Покупателю универсальный передаточный документ (УПД) в двух экземплярах, в котором отражается объем и стоимость поставленного по транспортным накладным Товара в течение предыдущей недели. Покупатель обязан подписать полученный УПД и вернуть один экземпляр УПД Поставщику в течение трёх рабочих дней с даты получения от Поставщика. В случае обнаружения неточностей в оформлении УПД Покупатель уведомляет об этом Поставщика, и Стороны оформляют уточнённый УПД.
2.10.	Покупатель несёт ответственность за подготовку своего объекта к приёмке автотранспорта Поставщика с Товаром, - в частности, должны быть подготовлены подъездные пути к объекту, площадка для выгрузки Товара, площадка для разворота автотранспорта. Покупатель обязан в течение двух дней с даты получения обращения оплатить расходы Поставщика в связи неготовностью объекта Покупателя к приемке и выгрузке грузового автотранспорта (например, расходы на вытягивание увязшего в грунте или снегу автотранспорта, расходы на ремонт поломки/повреждения автотранспорта в связи с неготовностью объекта, иные расходы по устранению ситуации на объекте и ремонту автотранспорта, и т.д.).

3.	Приемка Товара по качеству и количеству

3.1.	Поставщик гарантирует, что поставляемый Товар соответствует качеству, предъявляемому законом к данному Товару. Качество Товара предполагается надлежащим, пока Покупателем не доказано иное.
3.2.	Покупатель уведомлен, что действующее законодательство Российской Федерации и технические регламенты не предусматривают норм, устанавливающих гарантийный срок на Товар. Покупатель уведомлен, что качество Товара может быть напрямую связано с условиями хранения Товара у Покупателя.
3.3.	Покупатель вправе самостоятельно и за свой счет проверить качество Товара до подписания Спецификации посредством осуществления лабораторного испытания Товара на карьере.
3.4.	Приемка Товара по количеству при поставке Товара на условиях доставки осуществляется Покупателем или грузополучателем по месту назначения доставки Товара.
Факт приемки Товара по количеству подтверждается путём подписания Покупателем или его грузополучателем транспортной накладной. Транспортная накладная подписывается непосредственно после разгрузки транспортного средства Поставщика.
3.5.	В случае, если при приемке Товара по месту назначения Покупателя/грузополучателя у Покупателя возникнут возражения по количеству поставленного Товара, Покупатель обязан сделать отметку во всех экземплярах ТН о наличии расхождений по количеству, с указанием реального объёма, и незамедлительно вызвать представителя Поставщика для дальнейшего участия в приемке Товара и оформления акта об установленных расхождениях по количеству при приемке Товара по транспортной накладной.
В случае неявки представителя Поставщика в указанный срок, Покупатель имеет право в одностороннем порядке составить акт о несоответствии количества поставленного Товара количеству, указанному в ТН. Акт о несоответствии составляется применением видеосъёмки, позволяющей оценить доводы Покупателя.
3.6.	В случае, если Покупатель/грузополучатель необоснованно отказывается от приемки Товара в момент фактической отгрузки Товара, Покупатель обязан компенсировать Поставщику расходы, связанные с доставкой Товара.
 
3.7.	Претензии по качеству Товара могут предъявляться при условии соблюдения Покупателем условий приемки и хранения щебня в соответствии с ГОСТ 8267-93. Покупатель обязан не допускать засорение, загрязнение и намокание щебня. Обязанность доказывания надлежащего хранения щебня с момента выгрузки до момента предъявления претензии по качеству лежит на Покупателе.

4.	Цена Товара. Порядок расчетов

4.1.	Цена за Товар и порядок расчетов согласовываются Сторонами в Спецификациях, являющихся неотъемлемой частью настоящего Договора.
4.2.	Оплата считается произведенной в момент поступления денежных средств на расчётный счёт Поставщика.
4.3.	Если иное не предусмотрено Спецификацией, Товар поставляется при условии внесения 100% предоплаты. В случае невнесения предоплаты Поставщик вправе приостановить отгрузку Товара, и в таком случае Поставщик не считается просрочившим поставку.
4.4.	Покупатель согласен с тем, что в случае усиления весового контроля на автодорогах по сезонным причинам, или по усмотрению органов власти, загрузка автотранспорта Товаром может быть уменьшена, при этом стоимость доставки Товара по усмотрению Поставщика может быть увеличена в одностороннем внесудебном порядке на период действия весового контроля.

5.	Ответственность сторон

5.1.	В случаях ненадлежащего исполнения обязательств по настоящему Договору стороны несут ответственность в соответствии с действующим законодательством РФ.
5.2.	За несвоевременную поставку Товара Поставщиком Покупатель вправе начислить и потребовать оплаты неустойки в размере 0,1% от стоимости не поставленного в срок Товара за каждый день просрочки, но не более 10% от стоимости не поставленного в срок Товара. В случае поставки по предоплате неустойка на неоплаченный и не поставленный в срок Товар не начисляется и не выплачивается.
5.3.	При несоблюдении согласованного в Спецификации срока платежей, Поставщик вправе начислить Покупателю пеню в размере 1% от суммы задолженности за каждый день просрочки, но не более 100% от суммы задолженности.
5.4.	За простой автотранспорта Поставщика в ожидании разгрузки в месте назначения Покупателя свыше одного часа, Поставщик вправе потребовать оплаты штрафа в размере 2 000 рублей за каждый час ожидания.
5.5.	Уплата неустоек, а также возмещение убытков, не освобождает Стороны от исполнения своих обязательств в натуре.
5.6.	В случае нарушения одной из Сторон условий Договора, Сторона, обнаружившая соответствующее нарушение, направляет претензию другой Стороне с требованием об устранении нарушений, а также об оплате неустоек, штрафов, в том числе компенсации убытков, причиненных допущенными нарушениями. Штрафные санкции подлежат уплате виновной стороной в течение пяти рабочих дней с даты получения соответствующего требования (претензии). Уплата штрафных санкций не освобождает виновную сторону от выполнения принятых на себя обязательств или устранения нарушений.
5.7.	Доставка претензии производится заказным или ценным письмом Почтой России, или курьером под расписку о получении. Стороны вправе продублировать отправку претензии по электронной почте.
5.8.	Споры, возникающие из настоящего Договора, передаются на рассмотрение в Арбитражный суд Калужской области.
5.9.	В целях урегулирования спора Стороны предусматривают обязательный претензионный порядок регулирования спора. Срок направления ответа на претензию – 10 рабочих дней с даты получения претензии.

6.	Обстоятельства непреодолимой силы
 
6.1.	Сторона, не исполнившая или ненадлежащим образом исполнившая обязательства по настоящему Договору, не несет ответственности, если докажет, что надлежащее исполнение оказалось невозможным вследствие возникновения обстоятельств непреодолимой силы (форс- мажор).
6.2.	Под обстоятельствами непреодолимой силы подразумеваются: войны, наводнения, пожары, землетрясения и прочие стихийные бедствия, забастовки, изменения действующего законодательства или любые другие обстоятельства, на которые затронутая ими Сторона не может реально воздействовать и которые она не могла разумно предвидеть, и при этом они не позволяют исполнить обязательства по настоящему договору, и возникновение которых не явилось прямым или косвенным результатом действия или бездействия одной из Сторон.
6.3.	Сторона, не исполнившая обязательства по настоящему договору в силу возникновения обстоятельств непреодолимой силы, обязана в течение 5 (пяти) рабочих дней с момента наступления обстоятельств непреодолимой силы проинформировать об этом другую сторону в письменной форме. Такая информация должна содержать данные о характере обстоятельств непреодолимой силы, а также, по возможности, оценку их влияния на исполнение и возможный срок исполнения обязательств.
6.4.	По прекращении действия указанных обстоятельств потерпевшая сторона должна незамедлительно направить письменное уведомление об этом другой стороне с указанием срока, в который предполагается исполнить обязательства по настоящему договору.
6.5.	В случае возникновения обстоятельств непреодолимой силы срок исполнения обязательств по настоящему договору продлевается на срок действия обстоятельств непреодолимой силы и их последствий.
6.6.	В том случае, если обстоятельства непреодолимой силы препятствуют одной из Сторон выполнить её обязательства в течение срока, превышающего более 3 месяцев, любая из сторон может направить другой стороне уведомление с предложением о проведении переговоров с целью определения взаимоприемлемых условий выполнения обязательств по договору или прекращения его действия.
6.7.	Стороны не освобождаются от выполнения обязательств, срок выполнения которых наступил до возникновения обстоятельств непреодолимой силы.
6.8.	Надлежащим доказательством наличия обстоятельств непреодолимой силы и их продолжительности будут служить документы, выданные соответствующими государственными органами.

7.	Порядок изменения и расторжения настоящего Договора

7.1.	Условия настоящего Договора имеют одинаковую юридическую силу для Сторон Договора.
7.2.	Любые изменения и дополнения к настоящему Договору действительны при условии, если они совершены в письменной форме и подписаны надлежаще уполномоченными на то представителями Сторон.
7.3.	При изменении реквизитов, а также в случаях реорганизации и ликвидации Стороны обязаны в течение 5 (пяти) дней уведомить друг друга о произошедших изменениях.
В случае не извещения (несвоевременного извещения) об изменении адресов все уведомления, направленные по адресам, указанные в настоящем Договоре, считаются надлежащим уведомлением Сторон.
7.4.	Настоящий Договор может быть изменен или расторгнут по соглашению Сторон. Стороны должны выполнить все свои обязательства по Договору, возникшие до момента прекращения его действия.
Сторона, которой направлено предложение о расторжении настоящего Договора по соглашению Сторон, должна дать письменный ответ по существу в срок не позднее 5 (пяти) рабочих дней со дня его получения. Расторжение настоящего Договора производится путем подписания Сторонами соответствующего соглашения о расторжении.
7.5.	Покупатель вправе в одностороннем внесудебном порядке расторгнуть настоящий Договор в случае неоднократного нарушения Поставщиком сроков поставки.
 
7.6.	Поставщик вправе в одностороннем внесудебном порядке расторгнуть настоящий Договор в случаях:
-	неоднократного нарушения сроков оплаты Товара Покупателем,
-	неоднократной невыборки объёмов Товара Покупателем.
7.7.	Уведомление о расторжении Договора (отказе от Договора) направляется заинтересованной Стороной в адрес другой Стороны заказным или ценным письмом Почтой России, при этом Стороны вправе продублировать отправку по электронной почте.
7.8.	Любая из Сторон по собственной инициативе вправе расторгнуть в одностороннем внесудебном порядке Договор, при условии уведомления другой Стороны не менее, чем за 15 дней до даты расторжения. При этом все обязательства, возникшие до даты расторжения Договора, подлежат исполнению Сторонами.
7.9.	Стороны исходят из того, что прекращение действия настоящего Договора по любой причине должно сводить к минимальному ущербу для Сторон.

8.	Срок действия Договора

8.1.	Настоящий Договор вступает в силу с момента подписания его Сторонами и действует до
«31» декабря 2024 года, а в части обязательств, принятых сторонами до окончания срока действия Договора, - до их полного надлежащего исполнения Сторонами.
8.2.	В случае, если ни одна из Сторон до окончания срока действия Договора не заявила о его расторжении, то действие Договора возобновляется на аналогичный период на тех же условиях.

9.	Конфиденциальность

9.1.	Стороны настоящим подтверждают, что информация, которой они обмениваются в рамках подготовки, а также после заключения настоящего Договора, носит конфиденциальный характер, являясь ценной для Сторон и не подлежащей разглашению, поскольку составляет служебную и/или коммерческую тайну, имеет действительную и потенциальную коммерческую ценность в силу ее неизвестности третьим лицам, к ней нет свободного доступа на законном основании.
9.2.	Никакая такая информация не может быть разглашена какой-либо из Сторон, каким бы то ни было другим лицам или организациям без предварительного письменного согласия на это другой Стороны в течение срока действия настоящего Договора.
9.3.	Каждая Сторона обязана принимать все разумные меры, необходимые и целесообразные для предотвращения несанкционированного раскрытия конфиденциальной информации. При этом принимаемые меры должны быть не менее существенны, чем те, которые Сторона принимает для сохранения своей собственной информации подобного рода.

10.	Заверения об обстоятельствах

10.1.	До момента подписания Договора Покупатель обязан предоставить следующий пакет документов (в копиях):
-	решение (протокол) о создании Покупателя;
-	устав Покупателя;
-	свидетельство о государственной регистрации Покупателя в качестве юридического лица;
-	свидетельство о постановке на налоговый учет Покупателя;
-	решение (протокол) о назначении единоличного исполнительного органа Покупателя (генерального директора и т.п.);
-	бухгалтерский баланс и отчет о прибылях и убытках за последние два года.
10.2.	При подписании настоящего Договора Стороны на основании ст.431.2 ГК РФ заверяют друг друга о нижеследующем:
10.2.1.	Стороны соответствуют признакам добросовестного налогоплательщика, уплачивают все налоги и сборы в соответствии с законодательством Российской Федерации (не имеет недоимок по уплате налогов и сборов), а также ведут и своевременно подают в налоговые и иные государственные органы
 
налоговую, статистическую и иную государственную отчетность в соответствии с требованиями законодательства Российской Федерации;
10.1.1.	В отношении Сторон не начата процедура несостоятельности (банкротства), и Сторона не находится в процессе добровольной или принудительной ликвидации в соответствии с налоговым законодательством Российской Федерации;
10.1.2.	Каждая из Сторон действует сознательно, добровольно, понимает значение своих действий, не совершает сделку на крайне невыгодных для себя условиях и (или) под влиянием обстоятельств, вынуждающих его совершать сделку, не заблуждается относительно сделки;
10.1.3.	Стороны не скрывают каких-либо фактов, которые, будучи известными Сторонам, могли бы оказать неблагоприятное влияние на решение Сторон о заключении Договора;
10.1.4.	Исполнение Договора не нарушает интеллектуальных прав третьих лиц, в том числе авторских и патентных;
10.1.5.	Каждая из Сторон обязуется своевременно исполнять в полном объеме все свои налоговые обязательства, предусмотренные Договором;
10.1.6.	Основной целью совершения Договора не является неуплата (неполная уплата) и (или) зачет (возврат) суммы налога;
10.1.7.	Стороны являются законными владельцами имущества, необходимого для исполнения предусмотренных Договором обязательств;
10.1.8.	Покупатель и клиенты Покупателя не приобретают Товар для целей исполнения государственного контракта или контракта в сфере  
государственного оборонного заказа.
10.2.	Нарушение положений п.10.2. (включая подпункты) Договора является основанием для одностороннего внесудебного расторжения Договора и предъявлением требований о возмещении убытков, причиненных таким нарушением.
10.3.	В случае взыскания с Поставщика неустоек, штрафов, в том числе административных штрафов, взыскания прочих расходов и причинения убытков со стороны органов государственной власти, в связи с исполнением Покупателем или его клиентами государственных контрактов, контрактов в сфере государственного оборонного заказа, и наложением в связи с этим дополнительных обязательств на Поставщика, Покупатель обязан возместить такие штрафы, неустойки, убытки в полном объёме и выплатить Поставщику неустойку в размере 1 000 000 (один миллион) рублей в течение пяти рабочих дней с даты получения от Поставщика соответствующего письменного требования. При этом Поставщик не обязан оспаривать законность действий органов государственной власти.
11	Прочие условия
11.1 Переписка по электронной связи, позволяющая однозначно идентифицировать отправителя–Сторону по Договору и содержание отправленного документа, признается сторонами как имеющая юридическую силу до момента получения оригиналов.
11.2 Уступка прав требования третьим лицам без согласования Сторон по настоящему Договору не допускается.
11.3.	Стороны могут осуществлять документооборот, связанный с исполнением настоящего Договора, посредством системы электронного документооборота, с которой возможен роуминг документов из системы ЭДО.
11.4.	Стороны признают юридическую силу за документами, подписываемыми аналогами собственноручной подписи, в том числе: счетами, УПД, актами сверки, письмами (уведомлениями). Электронные документы признаются эквивалентными соответствующим бумажным документам и порождают аналогичные им права и обязанности сторон.
`;

export default function ContractAnalyzer() {
    const [contractText, setContractText] = useState("");
    const [perspective, setPerspective] = useState<AnalysisPerspective>('buyer');
    const [checklistText, setChecklistText] = useState(buyerChecklist);
    const [riskText, setRiskText] = useState(buyerRisks);
    const [contractParagraphs, setContractParagraphs] = useState<ContractParagraph[]>([]);
    const [missingRequirements, setMissingRequirements] = useState<ContractParagraph[]>([]);
    const [ambiguousConditions, setAmbiguousConditions] = useState<ContractParagraph[]>([]);
    const [structuralAnalysis, setStructuralAnalysis] = useState<any>(null);
    const [contradictions, setContradictions] = useState<Contradiction[]>([]);
    const [rightsImbalance, setRightsImbalance] = useState<RightsImbalance[]>([]);
    const [showCompliance, setShowCompliance] = useState(true);
    const [showPartial, setShowPartial] = useState(true);
    const [showRisks, setShowRisks] = useState(true);
    const [showMissing, setShowMissing] = useState(true);
    const [showOther, setShowOther] = useState(true);
    const [showContradictions, setShowContradictions] = useState(true);
    const [isAnalyzing, setIsAnalyzing] = useState(false);

    const { analyzeContract, isLoading, error, progress } = useGeminiAnalysis();
    
    // Ссылка на раздел структурного анализа для автоматической прокрутки
    const structuralAnalysisRef = useRef<HTMLDivElement>(null);

    // Автоматическая прокрутка к структурному анализу после завершения анализа
    useEffect(() => {
        if (structuralAnalysis && !isAnalyzing && structuralAnalysisRef.current) {
            // Небольшая задержка для завершения рендеринга
            setTimeout(() => {
                if (structuralAnalysisRef.current) {
                    // Получаем позицию элемента
                    const elementTop = structuralAnalysisRef.current.offsetTop;
                    // Вычитаем высоту заголовка (64px) + дополнительный отступ (24px)
                    const offsetTop = elementTop - 88;
                    
                    window.scrollTo({
                        top: offsetTop,
                        behavior: 'smooth'
                    });
                }
            }, 300);
        }
    }, [structuralAnalysis, isAnalyzing]);


    const handlePerspectiveChange = (newPerspective: 'buyer' | 'supplier') => {
        setPerspective(newPerspective);
        // Сбрасываем результаты анализа при смене перспективы
        setContractParagraphs([]);
        setMissingRequirements([]);
        setAmbiguousConditions([]);
        setStructuralAnalysis(null);
        setContradictions([]);
        setRightsImbalance([]);
        
        // Обновляем чек-лист и риски в зависимости от перспективы
        if (newPerspective === 'buyer') {
            setChecklistText(buyerChecklist);
            setRiskText(buyerRisks);
        } else {
            setChecklistText(supplierChecklist);
            setRiskText(supplierRisks);
        }
    };

    const handleAnalyze = async () => {
        if (!contractText.trim() || !checklistText.trim()) {
            alert("Пожалуйста, заполните текст договора и чек-лист");
            return;
        }

        setIsAnalyzing(true);
        
        try {
            const { contractParagraphs, missingRequirements, ambiguousConditions, structuralAnalysis, contradictions, rightsImbalance } = await analyzeContract(
                contractText,
                checklistText,
                riskText,
                perspective,
                (progressMessage: string) => {
                    console.log("Progress:", progressMessage);
                }
            );
            
            setContractParagraphs(contractParagraphs || []);
            setMissingRequirements(missingRequirements || []);
            setAmbiguousConditions(ambiguousConditions || []);
            setStructuralAnalysis(structuralAnalysis || null);
            setContradictions(contradictions || []);
            setRightsImbalance(rightsImbalance || []);
            
            // Успешное завершение - останавливаем анализ
            setIsAnalyzing(false);
        } catch (error) {
            console.error("Analysis failed:", error);
            setIsAnalyzing(false);
        }
    };

    const handleAnalysisComplete = () => {
        // Прогресс-бар сам управляет своим состоянием
        // Ничего не делаем здесь
    };

    const handleUpdateComment = (id: string, newComment: string) => {
        setContractParagraphs(prev => 
            prev.map(paragraph => 
                paragraph.id === id 
                ? { ...paragraph, comment: newComment }
                : paragraph
            )
        );
        
        setMissingRequirements(prev => 
            prev.map(requirement => 
                requirement.id === id 
                ? { ...requirement, comment: newComment }
                : requirement
            )
        );
        
        setAmbiguousConditions(prev => 
            prev.map(condition => 
                condition.id === id 
                ? { ...condition, comment: newComment }
                : condition
            )
        );
    };

    const handleSubmitFeedback = (feedback: any) => {
        console.log('Feedback received:', feedback);
        // Здесь можно отправить отзыв на сервер для дальнейшего анализа
    };

    const loadExample = () => {
        setContractText(defaultContractText);
    };

    // Добавляем проверку на undefined
    const filteredResults = (contractParagraphs || []).filter((paragraph) => {
        if (!paragraph.category) return true;
        if (paragraph.category === 'checklist' && !showCompliance) return false;
        if (paragraph.category === 'partial' && !showPartial) return false;
        if (paragraph.category === 'risk' && !showRisks) return false;
        if (paragraph.category === 'missing' && !showMissing) return false;
        if ((paragraph.category === 'other' || paragraph.category === 'ambiguous') && !showOther) return false;
        return true;
    });

    // Добавляем проверку на undefined
    const complianceCount = (contractParagraphs || []).filter(p => p.category === 'checklist').length;
    const partialCount = (contractParagraphs || []).filter(p => p.category === 'partial').length;
    const riskCount = (contractParagraphs || []).filter(p => p.category === 'risk').length;
    const missingCountFromParagraphs = (contractParagraphs || []).filter(p => p.category === 'missing').length;
    const missingCountTotal = missingCountFromParagraphs + (missingRequirements || []).length;
    const otherCount = (contractParagraphs || []).filter(p => p.category === 'other' || p.category === 'ambiguous').length;

    return (
        <div className="min-h-screen bg-gray-50">
            {/* Header */}
            <header className="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between items-center h-16">
                        <div className="flex items-center space-x-3">
                            <div className="w-8 h-8 hf-orange-bg rounded-lg flex items-center justify-center">
                                <File className="text-white text-sm" size={16} />
                            </div>
                            <div>
                                <h1 className="text-xl font-semibold text-gray-900">AI Скрепка</h1>
                            </div>
                        </div>
                        <div className="flex items-center space-x-4">
                            <Button
                                variant="outline"
                                onClick={() => window.open('/analytics', '_blank')}
                                className="text-sm"
                            >
                                Аналитика качества
                            </Button>
                            <div className="flex items-center space-x-2 text-sm text-gray-600">
                                <span className="w-2 h-2 bg-green-400 rounded-full"></span>
                                <span>Gemini API подключен</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {/* Hero Section */}
                <div className="text-center mb-12">
                    <h2 className="text-3xl font-bold text-gray-900 mb-4">AI проверка договоров поставки</h2>
                    <p className="text-lg text-gray-600 max-w-3xl mx-auto">
                        Установите корпоративные критерии, риски и обязательные условия.
                    </p>
                    <p className="text-lg text-gray-600 max-w-3xl mx-auto">
                        Сервис проконтролирует, чтобы каждый договор поставки им соответствовал.
                    </p>
                </div>

                <div className="space-y-8">
                    {/* Input Panel - Full Width */}
                    <div className="space-y-6">
                        {/* Contract Input and Perspective Selection in parallel */}
                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            <div className="lg:col-span-3">
                                <ContractInput
                                    value={contractText}
                                    onChange={setContractText}
                                />
                            </div>
                            <div className="lg:col-span-1">
                                <PerspectiveSelector
                                    perspective={perspective}
                                    onPerspectiveChange={handlePerspectiveChange}
                                />
                            </div>
                        </div>

                        {/* Requirements and Risks in parallel */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <RequirementsInput
                                value={checklistText}
                                onChange={setChecklistText}
                                perspective={perspective}
                            />
                            <RiskInput
                                value={riskText}
                                onChange={setRiskText}
                                perspective={perspective}
                            />
                        </div>

                        {/* Analysis Button */}
                        <div className="flex flex-col items-center mt-6">
                            <Button
                                onClick={handleAnalyze}
                                disabled={!contractText.trim() || isLoading || isAnalyzing}
                                className="hf-orange-bg hover:hf-orange-bg text-white px-8 py-4 h-auto text-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
                            >
                                <ChartLine className="mr-2" size={20} />
                                {isAnalyzing ? 'Анализируем...' : 'Анализировать договор'}
                                <File className="ml-2" size={20} />
                            </Button>
                        </div>

                        {/* Examples Section */}
                        <div className="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 p-3">
                            <Button
                                onClick={loadExample}
                                variant="ghost"
                                className="w-full p-3 h-auto text-left hover:bg-gray-50 transition-all rounded-lg"
                            >
                                <div className="flex items-center">
                                    <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center mr-3">
                                        <File className="text-blue-600" size={16} />
                                    </div>
                                    <div>
                                        <div className="font-medium text-gray-900">Попробуйте пример договора</div>
                                        <div className="text-sm text-gray-500">Стандартный договор поставки товаров</div>
                                    </div>
                                </div>
                            </Button>
                        </div>
                    </div>


                    {/* Error Display */}
                    {error && (
                        <div className="mt-6 bg-red-50 border border-red-200 rounded-xl p-6">
                            <div className="flex items-center">
                                <div className="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                                    <span className="text-red-600 text-sm">⚠</span>
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold text-red-800">Ошибка анализа</h3>
                                    <p className="text-red-600 mt-1">{error}</p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Results Layout with Table of Contents */}
                    {(structuralAnalysis || contractParagraphs.length > 0) && (
                        <div className="mt-6 grid grid-cols-1 lg:grid-cols-4 gap-8">
                            {/* Main Content - narrower */}
                            <div className="lg:col-span-3 space-y-6">
                                {/* Structural Analysis */}
                                {structuralAnalysis && (
                                    <div id="structural-analysis" ref={structuralAnalysisRef}>
                                        <StructuralAnalysisComponent analysis={structuralAnalysis} />
                                    </div>
                                )}
                                
                                {/* Results */}
                                {contractParagraphs.length > 0 && (
                                    <div id="analysis-results">
                                        <AnalysisResults
                                            contractParagraphs={contractParagraphs}
                                            missingRequirements={missingRequirements}
                                            ambiguousConditions={ambiguousConditions}
                                            showCompliance={showCompliance}
                                            showPartial={showPartial}
                                            showRisks={showRisks}
                                            showOther={showOther}
                                            showMissing={showMissing}
                                            exportToDocx={() => exportToDocx(contractParagraphs)}
                                            onUpdateComment={handleUpdateComment}
                                            onSubmitFeedback={handleSubmitFeedback}
                                            showContradictions={showContradictions}
                                            onToggleCompliance={setShowCompliance}
                                            onTogglePartial={setShowPartial}
                                            onToggleRisks={setShowRisks}
                                            onToggleMissing={setShowMissing}
                                            onToggleOther={setShowOther}
                                            onToggleContradictions={setShowContradictions}
                                            complianceCount={complianceCount}
                                            partialCount={partialCount}
                                            riskCount={riskCount}
                                            missingCount={missingCountTotal}
                                            otherCount={otherCount}
                                            contradictionsCount={contradictions.length}
                                        />
                                    </div>
                                )}

                                {/* Отсутствующие требования — якорь в компоненте AnalysisResults */}
                                
                                {/* Contradictions Results */}
                                <div id="contradictions-results">
                                    <ContradictionsResults
                                        contradictions={contradictions}
                                        showContradictions={showContradictions}
                                    />
                                </div>

                                {/* Rights Imbalance Results */}
                                <div id="rights-imbalance-results">
                                    <RightsImbalanceResults
                                        rightsImbalance={rightsImbalance}
                                    />
                                </div>
                            </div>

                            {/* Table of Contents and Filters - Right Sidebar */}
                            <div className="lg:col-span-1">
                                <div className="sticky top-24 space-y-6">
                                    <TableOfContents
                                        hasStructuralAnalysis={!!structuralAnalysis}
                                        hasResults={contractParagraphs.length > 0}
                                        hasContradictions={contradictions.length > 0}
                                        hasRightsImbalance={rightsImbalance.length > 0}
                                        hasMissingRequirements={missingRequirements.length > 0}
                                    />
                                    {/* Фильтр — отдельный блок под оглавлением */}
                                    {contractParagraphs.length > 0 && (
                                        <FloatingFilters
                                            showCompliance={showCompliance}
                                            showPartial={showPartial}
                                            showRisks={showRisks}
                                            showMissing={showMissing}
                                            showOther={showOther}
                                            showContradictions={showContradictions}
                                            onToggleCompliance={setShowCompliance}
                                            onTogglePartial={setShowPartial}
                                            onToggleRisks={setShowRisks}
                                            onToggleMissing={setShowMissing}
                                            onToggleOther={setShowOther}
                                            onToggleContradictions={setShowContradictions}
                                            complianceCount={complianceCount}
                                            partialCount={partialCount}
                                            riskCount={riskCount}
                                            missingCount={missingCountTotal}
                                            otherCount={otherCount}
                                            contradictionsCount={contradictions.length}
                                        />
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <AnalysisProgress
                        isAnalyzing={isAnalyzing}
                        onComplete={handleAnalysisComplete}
                        progress={progress}
                    />
                    {/* Оцените качество анализа — всегда в самом конце */}
                    {(structuralAnalysis || contractParagraphs.length > 0) && (
                        <div className="mt-12">
                            <QualityFeedback 
                                analysisId={`analysis_${Date.now()}`}
                                onSubmitFeedback={handleSubmitFeedback}
                            />
                        </div>
                    )}
                </div>
            </div>
            {/* Footer */}
            <footer className="bg-white border-t border-gray-200 mt-16">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div className="text-center">
                        <p className="text-sm text-gray-600">
                            Проект телеграм-канала{' '}
                            <a
                                href="https://t.me/+plgepYs_y0M3ODJi"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="hf-orange-text hover:text-orange-700 font-medium transition-colors"
                            >
                                "AI Скрепка: Связь Права и Технологий"
                            </a>
                        </p>
                        <p className="text-xs text-gray-500 mt-2">
                            Разработчик: Мирошниченко Евгений — старший юрист в консалтинге и энтузиаст новых технологий
                        </p>
                    </div>
                </div>
            </footer>
        </div> // ИСПРАВЛЕНИЕ: Закрывающий тег для корневого <div className="min-h-screen bg-gray-50">
    );
}
import { useState, useEffect } from "react";
import { File, ChartLine, AlertTriangle, CheckCircle, Clock } from "lucide-react";
import { ContractInput } from "@/components/contract-input";
import { RequirementsInput } from "@/components/requirements-input";
import { RiskInput } from "@/components/risk-input";
import { AnalysisResults } from "@/components/analysis-results";
import { SidebarFilters } from "@/components/sidebar-filters";
import { PerspectiveSelector, type AnalysisPerspective } from "@/components/perspective-selector";
import { AnalysisProgress } from "@/components/analysis-progress";
import { StructuralAnalysisComponent } from "@/components/structural-analysis";
import { Button } from "@/components/ui/button";
import { useGeminiAnalysis } from "@/hooks/use-gemini-analysis";
import { exportToDocx } from "@/lib/docx-export";
import type { ContractParagraph } from "@shared/schema";

// Требования и риски для ПОКУПАТЕЛЯ
const buyerChecklist = `• Поставка товара (наименование, количество, цена, срок) определяется через Заявки Покупателя, подтверждаемые Счетом Поставщика, и/или через подписанные Спецификации.
• Установлены конкретные сроки поставки или четкий механизм их определения для каждой партии Товара (например, X дней с момента подтверждения Заявки или указание конкретной даты в Спецификации).
• Поставщик гарантирует, что товар свободен от прав третьих лиц, не в залоге, не под арестом.
• Прямо указано, что товар, поставленный в кредит (с отсрочкой платежа), не находится в залоге у Поставщика до момента оплаты.
• Поставщик гарантирует соответствие товара стандартам и ТУ РФ, а также требованиям для оптовой/розничной торговли в РФ.
• Поставщик обязан предоставить сертификаты/декларации соответствия и другие необходимые документы (паспорта, инструкции на русском, гарантийные талоны) вместе с товаром.
• Поставщик подтверждает Заявку выставлением Счета в течение короткого срока (например, 1-2 банковских дня).
• Четко определен один вариант: либо самовывоз со склада Поставщика (адрес указан), либо доставка на склад Покупателя (адрес указан).
• Датой поставки считается дата фактической приемки товара Покупателем и подписания товаросопроводительных документов (ТОРГ-12/УПД/ТТН).
• Установлен разумный срок для приемки Покупателем (например, 5-10 банковских дней с даты поставки).
• Установлен разумный срок для приемки Покупателем (например, 10-15 банковских дней с даты поставки).
• Претензии могут быть предъявлены в течение всего гарантийного срока на товар.
• Срок уведомления Поставщика о выявленных недостатках – не более 5 банковских дней с момента обнаружения.
• Поставщик обязан направить представителя для составления акта в течение 5 рабочих дней с момента уведомления. При неявке Покупатель вправе составить акт в одностороннем порядке, и этот акт имеет силу.
• Для фиксации расхождений используется Акт (например, ТОРГ-2) или Акт о браке, составляемый Покупателем.
• Покупатель имеет право отказаться от приемки всей партии товара, если доля брака превышает 5%.
• Право собственности и риски переходят к Покупателю в момент фактической приемки товара и подписания товаросопроводительных документов.
• Цена фиксируется в Счетах/Спецификациях. Изменение возможно только по письменному соглашению сторон с предварительным уведомлением не менее чем за 14 рабочих дней. Цена на уже согласованные поставки не меняется.
• Указано, что отсрочка/рассрочка платежа Покупателем не является коммерческим кредитом (во избежание начисления % по ст. 317.1 ГК РФ по умолчанию).
• Обязанность Покупателя по оплате считается исполненной в момент списания денежных средств с корреспондентского счета банка Покупателя.
• Поставщик обязан заменить некачественный товар или вернуть деньги в течение короткого срока (например, 5 банковских дней) с момента получения требования Покупателя.
• Установлена неустойка (пеня) за просрочку замены/возврата денег за некачественный товар (например, 0.2% от стоимости такого товара за каждый день просрочки).
• Установлена неустойка (пеня) за нарушение срока поставки (например, 0.2% от стоимости не поставленного в срок товара за каждый день просрочки).
• Поставщик обязан возместить Покупателю убытки, причиненные неисполнением/ненадлежащим исполнением договора (желательно сверх неустойки).
• Поставщик компенсирует расходы Покупателя на возврат некачественного товара, если Поставщик оспаривает брак или не забирает его своевременно.
• Указан разумный срок (например, 5 дней) для уведомления о форс-мажоре и необходимость предоставления подтверждающего документа компетентного органа.
• Предусмотрен обязательный претензионный порядок разрешения споров со сроком рассмотрения претензии (например, 14 календарных дней).
• Споры рассматриваются в Арбитражном суде по месту нахождения Покупателя (например, АС Калужской области).
• Предусмотрена автоматическая пролонгация на следующий год, если ни одна из сторон не заявит о расторжении за 1 месяц до окончания текущего срока.
• Установлено ли, что предварительная оплата Покупателем товара (партии товара) является коммерческим кредитом, и что Поставщик по письменному требованию Покупателя уплачивает проценты в следующем или аналогичном порядке: до истечения срока поставки товара - 0% годовых; со дня, следующего за последним днем истечения срока поставки и до момента полного исполнения Поставщиком обязанности по поставке товара – повышенная ставка (например, 60 % годовых). Проценты начисляются до момента поставки товара (партии товара) в полном объеме. (Желательно с указанием порядка расчета: кол-во дней в месяце - 30, в году - 360).
• Документы (договор, приложения, заявки, счета), переданные по электронной почте или факсу, имеют юридическую силу до обмена оригиналами.`;

const buyerRisks = `• Любые пункты, ограничивающие ответственность Поставщика (например, только реальным ущербом, суммой договора/партии, исключение упущенной выгоды).
• Право Поставщика в одностороннем порядке менять цену, ассортимент, сроки поставки без согласия Покупателя или с коротким уведомлением.
• Переход рисков к Покупателю до фактической приемки (например, на складе Поставщика при доставке Поставщиком).
• Необоснованно короткие сроки для приемки, предъявления претензий.
• Сложная процедура, требующая обязательного присутствия Поставщика без права на односторонний акт, возложение расходов на экспертизу на Покупателя по умолчанию.
• Непропорционально высокие штрафы для Покупателя, особенно за незначительные нарушения.
• Ответственность Поставщика за просрочку/брак отсутствует или существенно ниже желаемой (см. чек-лист).
• Рассмотрение споров по месту нахождения Поставщика, третейский суд с неизвестным регламентом.
• Возможность для Поставщика приостанавливать поставки по неочевидным или незначительным причинам (кроме прямой просрочки оплаты).
• Условие, что право собственности переходит к Покупателю только после полной оплаты (если это не согласовано как исключительная мера).
• Нет явных гарантий Поставщика об отсутствии прав третьих лиц на товар.
• Особенно в сочетании со слабой ответственностью Поставщика за срыв поставки.`;

// Требования и риски для ПОСТАВЩИКА
const supplierChecklist = `✓ Предоплата не менее 50% от суммы договора
✓ Право на одностороннее изменение цены при изменении стоимости сырья
✓ Ограничение ответственности размером полученной предоплаты
✓ Возможность частичной поставки товаров
✓ Передача права собственности только после полной оплаты
✓ Право на приостановку поставок при просрочке платежей
✓ Исключение ответственности за форс-мажорные обстоятельства
✓ Право на досрочное расторжение при нарушениях покупателем`;

const supplierRisks = `⚠️ Предоплата менее 30% от суммы договора
⚠️ Неограниченная материальная ответственность поставщика
⚠️ Штрафные санкции более 1% в день за просрочку
⚠️ Обязательство возмещения всех косвенных убытков
⚠️ Невозможность изменения цены договора
⚠️ Право покупателя на одностороннее расторжение без компенсаций
⚠️ Обязательство поставки в любых обстоятельствах
⚠️ Длительные сроки гарантийных обязательств (более 24 месяцев)`;

const exampleContract = `ДОГОВОР ПОСТАВКИ

1.	Предмет Договора

1.1.	Поставщик обязуется осуществить поставку сыпучих строительных материалов (далее – Товар) на условиях, предусмотренных настоящим Договором, а Покупатель обязуется принять и оплатить Товар.
1.2.	Наименование, ассортимент, количество и цена Товара, сроки поставки, наименование грузополучателя (при наличии), адрес места назначения доставки Товара (место поставки Товара), условия оплаты и иные условия поставки определяются на основании подписанных Сторонами Спецификаций, являющихся неотъемлемой частью настоящего Договора.
1.3.	В случае расхождений между условиями Договора и условиями Спецификации применяются условия, согласованные в Спецификации.

2.	Порядок поставки

2.1.	Оформление Спецификации инициируется Поставщиком по заявке Покупателя. Заявка направляется Поставщику в произвольной письменной форме по электронной почте или телефону (в т.ч. с помощью мессенджеров), с указанием наименования Товара, необходимого количества и предполагаемых сроков поставки, иных пожеланий Покупателя. Вопросы, связанные с подготовкой Спецификации, могут согласовываться в рабочем порядке, в т.ч. по телефону. На основе заявки Покупателя Поставщик готовит Спецификацию, которую направляет Покупателю для подписания и оформления. Подписание Спецификации налагает на Стороны взаимные обязательства, подлежащие исполнению.
2.2.	Если иное не предусмотрено Спецификацией, то поставка Товара организуется Поставщиком до места назначения, указанного Покупателем.
2.3.	Товар доставляется Покупателю или грузополучателю, указанному Покупателем, автомобильным транспортом.
2.4.	Количество (масса) Товара определяется взвешиванием гружёного Товаром транспортного средства на весах, установленных на карьере. Количество Товара указывается в товарно- транспортной накладной или транспортной накладной.
2.5.	На каждое автотранспортное средство, задействованное в доставке Товара до Покупателя/грузополучателя оформляется товарно-транспортная накладная или транспортная накладная, на усмотрение Поставщика (далее по тексту «ТН», «транспортная накладная»).
2.6.	Поставка Товара осуществляется Поставщиком путем доставки Товара на склад/до места назначения Покупателя/грузополучателя. Датой поставки считается дата доставки Товара до места назначения Покупателя/грузополучателя и подписания представителем Покупателя/грузополучателя транспортной накладной. В целях реализации настоящего пункта Стороны устанавливают, что лицо, осуществляющее приёмку Товара в месте нахождения Покупателя/грузополучателя, является лицом, имеющим все необходимые полномочия для приёмки Товара и подписания транспортной накладной.
2.7.	Право собственности на Товар, поставляемый по настоящему Договору, а также риск случайной гибели или повреждения Товара переходят от Поставщика к Покупателю в момент подписания уполномоченным представителем Покупателя/грузополучателя транспортной накладной, подтверждающей приемку Товара. Подписание транспортной накладной подтверждает приемку Покупателем Товара по количеству, качеству и ассортименту.
2.8.	Покупатель обязан создать условия для правильной и своевременной приемки Товара, в том числе устройство и содержание в надлежащем состоянии подъездных дорог к месту разгрузки Товара, подготовка места разгрузки (площадки) Товара для его незамедлительной выгрузки, во избежание простоя автотранспортных средств Поставщика.
2.9.	Еженедельно, если иное не согласовано Сторонами в Спецификации, Поставщик предоставляет Покупателю универсальный передаточный документ (УПД) в двух экземплярах, в котором отражается объем и стоимость поставленного по транспортным накладным Товара в течение предыдущей недели. Покупатель обязан подписать полученный УПД и вернуть один экземпляр УПД Поставщику в течение трёх рабочих дней с даты получения от Поставщика. В случае обнаружения неточностей в оформлении УПД Покупатель уведомляет об этом Поставщика, и Стороны оформляют уточнённый УПД.
2.10.	Покупатель несёт ответственность за подготовку своего объекта к приёмке автотранспорта Поставщика с Товаром, - в частности, должны быть подготовлены подъездные пути к объекту, площадка для выгрузки Товара, площадка для разворота автотранспорта. Покупатель обязан в течение двух дней с даты получения обращения оплатить расходы Поставщика в связи неготовностью объекта Покупателя к приемке и выгрузке грузового автотранспорта (например, расходы на вытягивание увязшего в грунте или снегу автотранспорта, расходы на ремонт поломки/повреждения автотранспорта в связи с неготовностью объекта, иные расходы по устранению ситуации на объекте и ремонту автотранспорта, и т.д.).

3.	Приемка Товара по качеству и количеству

3.1.	Поставщик гарантирует, что поставляемый Товар соответствует качеству, предъявляемому законом к данному Товару. Качество Товара предполагается надлежащим, пока Покупателем не доказано иное.
3.2.	Покупатель уведомлен, что действующее законодательство Российской Федерации и технические регламенты не предусматривают норм, устанавливающих гарантийный срок на Товар. Покупатель уведомлен, что качество Товара может быть напрямую связано с условиями хранения Товара у Покупателя.
3.3.	Покупатель вправе самостоятельно и за свой счет проверить качество Товара до подписания Спецификации посредством осуществления лабораторного испытания Товара на карьере.
3.4.	Приемка Товара по количеству при поставке Товара на условиях доставки осуществляется Покупателем или грузополучателем по месту назначения доставки Товара. Факт приемки Товара по количеству подтверждается путём подписания Покупателем или его грузополучателем транспортной накладной. Транспортная накладная подписывается непосредственно после разгрузки транспортного средства Поставщика.
3.5.	В случае, если при приемке Товара по месту назначения Покупателя/грузополучателя у Покупателя возникнут возражения по количеству поставленного Товара, Покупатель обязан сделать отметку во всех экземплярах ТН о наличии расхождений по количеству, с указанием реального объёма, и незамедлительно вызвать представителя Поставщика для дальнейшего участия в приемке Товара и оформления акта об установленных расхождениях по количеству при приемке Товара по транспортной накладной. В случае неявки представителя Поставщика в указанный срок, Покупатель имеет право в одностороннем порядке составить акт о несоответствии количества поставленного Товара количеству, указанному в ТН. Акт о несоответствии составляется применением видеосъёмки, позволяющей оценить доводы Покупателя.
3.6.	В случае, если Покупатель/грузополучатель необоснованно отказывается от приемки Товара в момент фактической отгрузки Товара, Покупатель обязан компенсировать Поставщику расходы, связанные с доставкой Товара.
3.7.	Претензии по качеству Товара могут предъявляться при условии соблюдения Покупателем условий приемки и хранения щебня в соответствии с ГОСТ 8267-93. Покупатель обязан не допускать засорение, загрязнение и намокание щебня. Обязанность доказывания надлежащего хранения щебня с момента выгрузки до момента предъявления претензии по качеству лежит на Покупателе.

4.	Цена Товара. Порядок расчетов

4.1.	Цена за Товар и порядок расчетов согласовываются Сторонами в Спецификациях, являющихся неотъемлемой частью настоящего Договора.
4.2.	Оплата считается произведенной в момент поступления денежных средств на расчётный счёт Поставщика.
4.3.	Если иное не предусмотрено Спецификацией, Товар поставляется при условии внесения 100% предоплаты. В случае невнесения предоплаты Поставщик вправе приостановить отгрузку Товара, и в таком случае Поставщик не считается просрочившим поставку.
4.4.	Покупатель согласен с тем, что в случае усиления весового контроля на автодорогах по сезонным причинам, или по усмотрению органов власти, загрузка автотранспорта Товаром может быть уменьшена, при этом стоимость доставки Товара по усмотрению Поставщика может быть увеличена в одностороннем внесудебном порядке на период действия весового контроля.

5.	Ответственность сторон

5.1.	В случаях ненадлежащего исполнения обязательств по настоящему Договору стороны несут ответственность в соответствии с действующим законодательством РФ.
5.2.	За несвоевременную поставку Товара Поставщиком Покупатель вправе начислить и потребовать оплаты неустойки в размере 0,1% от стоимости не поставленного в срок Товара за каждый день просрочки, но не более 10% от стоимости не поставленного в срок Товара. В случае поставки по предоплате неустойка на неоплаченный и не поставленный в срок Товар не начисляется и не выплачивается.
5.3.	При несоблюдении согласованного в Спецификации срока платежей, Поставщик вправе начислить Покупателю пеню в размере 1% от суммы задолженности за каждый день просрочки, но не более 100% от суммы задолженности.
5.4.	За простой автотранспорта Поставщика в ожидании разгрузки в месте назначения Покупателя свыше одного часа, Поставщик вправе потребовать оплаты штрафа в размере 2 000 рублей за каждый час ожидания.
5.5.	Уплата неустоек, а также возмещение убытков, не освобождает Стороны от исполнения своих обязательств в натуре.
5.6.	В случае нарушения одной из Сторон условий Договора, Сторона, обнаружившая соответствующее нарушение, направляет претензию другой Стороне с требованием об устранении нарушений, а также об оплате неустоек, штрафов, в том числе компенсации убытков, причиненных допущенными нарушениями. Штрафные санкции подлежат уплате виновной стороной в течение пяти рабочих дней с даты получения соответствующего требования (претензии). Уплата штрафных санкций не освобождает виновную сторону от выполнения принятых на себя обязательств или устранения нарушений.
5.7.	Доставка претензии производится заказным или ценным письмом Почтой России, или курьером под расписку о получении. Стороны вправе продублировать отправку претензии по электронной почте.
5.8.	Споры, возникающие из настоящего Договора, передаются на рассмотрение в Арбитражный суд Калужской области.
5.9.	В целях урегулирования спора Стороны предусматривают обязательный претензионный порядок регулирования спора. Срок направления ответа на претензию – 10 рабочих дней с даты получения претензии.

6.	Обстоятельства непреодолимой силы

6.1.	Сторона, не исполнившая или ненадлежащим образом исполнившая обязательства по настоящему Договору, не несет ответственности, если докажет, что надлежащее исполнение оказалось невозможным вследствие возникновения обстоятельств непреодолимой силы (форс- мажор).
6.2.	Под обстоятельствами непреодолимой силы подразумеваются: войны, наводнения, пожары, землетрясения и прочие стихийные бедствия, забастовки, изменения действующего законодательства или любые другие обстоятельства, на которые затронутая ими Сторона не может реально воздействовать и которые она не могла разумно предвидеть, и при этом они не позволяют исполнить обязательства по настоящему договору, и возникновение которых не явилось прямым или косвенным результатом действия или бездействия одной из Сторон.
6.3.	Сторона, не исполнившая обязательства по настоящему договору в силу возникновения обстоятельств непреодолимой силы, обязана в течение 5 (пяти) рабочих дней с момента наступления обстоятельств непреодолимой силы проинформировать об этом другую сторону в письменной форме. Такая информация должна содержать данные о характере обстоятельств непреодолимой силы, а также, по возможности, оценку их влияния на исполнение и возможный срок исполнения обязательств.
6.4.	По прекращении действия указанных обстоятельств потерпевшая сторона должна незамедлительно направить письменное уведомление об этом другой стороне с указанием срока, в который предполагается исполнить обязательства по настоящему договору.
6.5.	В случае возникновения обстоятельств непреодолимой силы срок исполнения обязательств по настоящему договору продлевается на срок действия обстоятельств непреодолимой силы и их последствий.
6.6.	В том случае, если обстоятельства непреодолимой силы препятствуют одной из Сторон выполнить её обязательства в течение срока, превышающего более 3 месяцев, любая из сторон может направить другой стороне уведомление с предложением о проведении переговоров с целью определения взаимоприемлемых условий выполнения обязательств по договору или прекращения его действия.
6.7.	Стороны не освобождаются от выполнения обязательств, срок выполнения которых наступил до возникновения обстоятельств непреодолимой силы.
6.8.	Надлежащим доказательством наличия обстоятельств непреодолимой силы и их продолжительности будут служить документы, выданные соответствующими государственными органами.`;

export default function ContractAnalyzer() {
  const [contractText, setContractText] = useState("");
  const [perspective, setPerspective] = useState<AnalysisPerspective>('buyer');
  const [checklistText, setChecklistText] = useState(buyerChecklist);
  const [riskText, setRiskText] = useState(buyerRisks);
  const [contractParagraphs, setContractParagraphs] = useState<ContractParagraph[]>([]);
  const [missingRequirements, setMissingRequirements] = useState<ContractParagraph[]>([]);
  const [ambiguousConditions, setAmbiguousConditions] = useState<ContractParagraph[]>([]);
  const [structuralAnalysis, setStructuralAnalysis] = useState<any>(null);
  const [showCompliance, setShowCompliance] = useState(true);
  const [showPartial, setShowPartial] = useState(true);
  const [showRisks, setShowRisks] = useState(true);
  const [showMissing, setShowMissing] = useState(true);
  const [showOther, setShowOther] = useState(true);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  const { analyzeContract, isLoading, error } = useGeminiAnalysis();

  const handlePerspectiveChange = (newPerspective: 'buyer' | 'supplier') => {
    setPerspective(newPerspective);
    // Сбрасываем результаты анализа при смене перспективы
    setContractParagraphs([]);
    setMissingRequirements([]);
    setAmbiguousConditions([]);
    setStructuralAnalysis(null);
    // Автоматически обновляем чек-лист и риски при смене перспективы
    if (newPerspective === 'buyer') {
      setChecklistText(buyerChecklist);
      setRiskText(buyerRisks);
    } else {
      setChecklistText(supplierChecklist);
      setRiskText(supplierRisks);
    }
  };

  const handleAnalyze = async () => {
    if (!contractText.trim() || !checklistText.trim()) {
      alert("Пожалуйста, заполните текст договора и чек-лист");
      return;
    }

    setIsAnalyzing(true);
    
    try {
      const { contractParagraphs, missingRequirements, ambiguousConditions, structuralAnalysis } = await analyzeContract(
        contractText,
        checklistText,
        riskText,
        perspective
      );
      
      setContractParagraphs(contractParagraphs || []);
      setMissingRequirements(missingRequirements || []);
      setAmbiguousConditions(ambiguousConditions || []);
      setStructuralAnalysis(structuralAnalysis || null);
      
      // Успешное завершение - останавливаем анализ
      setIsAnalyzing(false);
    } catch (error) {
      console.error("Analysis failed:", error);
      setIsAnalyzing(false);
    }
  };

  const handleAnalysisComplete = () => {
    // Прогресс-бар сам управляет своим состоянием
    // Ничего не делаем здесь
  };

  const handleUpdateComment = (id: string, newComment: string) => {
    setContractParagraphs(prev => 
      prev.map(paragraph => 
        paragraph.id === id 
          ? { ...paragraph, comment: newComment }
          : paragraph
      )
    );
    
    setMissingRequirements(prev => 
      prev.map(requirement => 
        requirement.id === id 
          ? { ...requirement, comment: newComment }
          : requirement
      )
    );
    
    setAmbiguousConditions(prev => 
      prev.map(condition => 
        condition.id === id 
          ? { ...condition, comment: newComment }
          : condition
      )
    );
  };

  const handleSubmitFeedback = (feedback: any) => {
    console.log('Feedback received:', feedback);
    // Здесь можно отправить отзыв на сервер для дальнейшего анализа
  };

  const loadExample = () => {
    setContractText(exampleContract);
  };

  // Добавляем проверку на undefined
  const filteredResults = (contractParagraphs || []).filter((paragraph) => {
    if (!paragraph.category) return true;
    if (paragraph.category === 'checklist' && !showCompliance) return false;
    if (paragraph.category === 'partial' && !showPartial) return false;
    if (paragraph.category === 'risk' && !showRisks) return false;
    if (paragraph.category === 'missing' && !showMissing) return false;
    if (paragraph.category === 'other' && !showOther) return false;
    return true;
  });

  // Добавляем проверку на undefined
  const complianceCount = (contractParagraphs || []).filter(p => p.category === 'checklist').length;
  const partialCount = (contractParagraphs || []).filter(p => p.category === 'partial').length;
  const riskCount = (contractParagraphs || []).filter(p => p.category === 'risk').length;
  const missingCountFromParagraphs = (contractParagraphs || []).filter(p => p.category === 'missing').length;
  const missingCountTotal = missingCountFromParagraphs + (missingRequirements || []).length;
  const otherCount = (contractParagraphs || []).filter(p => p.category === 'other').length;

  // Функция для примерного подсчета токенов (1 токен ≈ 4 символа для русского текста)
  const estimateTokens = (text: string): number => {
    return Math.ceil(text.length / 3.5); // Более точная оценка для русского текста
  };

  // Подсчет общего количества токенов
  const totalTokens = estimateTokens(contractText + checklistText + riskText);
  const maxInputTokens = 1000000; // Лимит входных токенов для Gemini 2.0
  const maxOutputTokens = 32768;  // Лимит выходных токенов
  
  // Определяем статус по токенам
  const getTokenStatus = (tokens: number) => {
    const maxTokens = 7500; // Консервативный лимит для стабильности
    const percentage = (tokens / maxTokens) * 100;
    
    if (percentage < 70) {
      return { 
        color: 'text-green-600', 
        status: 'Хорошо',
        bgColor: 'bg-green-50',
        icon: CheckCircle
      };
    } else if (percentage < 90) {
      return { 
        color: 'text-yellow-600', 
        status: 'Внимание',
        bgColor: 'bg-yellow-50',
        icon: Clock
      };
    } else {
      return { 
        color: 'text-red-600', 
        status: 'Критично',
        bgColor: 'bg-red-50',
        icon: AlertTriangle
      };
    }
  };

  const tokenStatus = getTokenStatus(totalTokens);
  const TokenIcon = tokenStatus.icon;

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center space-x-3">
              <div className="w-8 h-8 hf-orange-bg rounded-lg flex items-center justify-center">
                <File className="text-white text-sm" size={16} />
              </div>
              <div>
                <h1 className="text-xl font-semibold text-gray-900">AI-анализ договоров поставки</h1>
                <p className="text-xs text-gray-500">Проект телеграм-канала "AI Скрепка: Связь Права и Технологий"</p>
              </div>
            </div>
            <div className="flex items-center space-x-4">
              <Button
                variant="outline"
                onClick={() => window.open('/analytics', '_blank')}
                className="text-sm"
              >
                Аналитика качества
              </Button>
              <div className="flex items-center space-x-2 text-sm text-gray-600">
                <span className="w-2 h-2 bg-green-400 rounded-full"></span>
                <span>Gemini API подключен</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Hero Section */}
        <div className="text-center mb-12">
          <h2 className="text-3xl font-bold text-gray-900 mb-4">Интеллектуальный анализ договоров</h2>
          <p className="text-lg text-gray-600 max-w-3xl mx-auto">
            Загрузите договор поставки и получите мгновенный AI-анализ с определением проблем соответствия, 
            рисков и рекомендаций на основе российского законодательства
          </p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Input Panel */}
          <div className="lg:col-span-2 space-y-6">
            <PerspectiveSelector 
              perspective={perspective}
              onPerspectiveChange={handlePerspectiveChange}
            />
            <ContractInput 
              value={contractText} 
              onChange={setContractText} 
            />
            <RequirementsInput 
              value={checklistText} 
              onChange={setChecklistText}
              perspective={perspective}
            />
            <RiskInput 
              value={riskText} 
              onChange={setRiskText}
              perspective={perspective}
            />

            {/* Analysis Button with Token Counter */}
            <div className="flex flex-col items-center mt-6 space-y-3">
              {/* Token Counter */}
              <div className={`flex items-center space-x-2 px-3 py-2 rounded-lg ${tokenStatus.bgColor} border`}>
                <TokenIcon className={tokenStatus.color} size={16} />
                <div className="flex flex-col">
                  <span className={`text-sm font-medium ${tokenStatus.color}`}>
                    {totalTokens.toLocaleString()} / 7,500 макс токенов
                  </span>
                  <span className="text-xs text-gray-500">
                    Gemini 2.0 Flash • Консервативный лимит
                  </span>
                </div>
              </div>
              
              {/* Warning message for high token usage */}
              {tokenStatus.status === 'Внимание' && (
                <p className="text-xs text-yellow-600 text-center max-w-md">
                  Приближаемся к лимиту выходных токенов. Ответ может быть сокращен.
                </p>
              )}
              {tokenStatus.status === 'Критично' && (
                <p className="text-xs text-red-600 text-center max-w-md">
                  Превышен безопасный лимит. Ответ будет обрезан. Сократите текст договора.
                </p>
              )}

            {/* Analysis Button */}
              <Button 
                onClick={handleAnalyze}
                disabled={!contractText.trim() || isLoading || isAnalyzing}
                className="hf-orange-bg hover:hf-orange-bg text-white px-8 py-4 h-auto text-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
              >
                <ChartLine className="mr-2" size={20} />
                {isAnalyzing ? 'Анализируем...' : 'Анализировать договор'}
                <File className="ml-2" size={20} />
              </Button>
            </div>
          </div>

          {/* Sidebar */}
          <SidebarFilters
            showCompliance={showCompliance}
            showPartial={showPartial}
            showRisks={showRisks}
            showMissing={showMissing}
            showOther={showOther}
            onToggleCompliance={setShowCompliance}
            onTogglePartial={setShowPartial}
            onToggleRisks={setShowRisks}
            onToggleMissing={setShowMissing}
            onToggleOther={setShowOther}
            hasResults={contractParagraphs.length > 0}
            complianceCount={complianceCount}
            partialCount={partialCount}
            riskCount={riskCount}
            missingCount={missingCountTotal}
            otherCount={otherCount}
          />
        </div>

        {/* Error Display */}
        {error && (
          <div className="mt-6 bg-red-50 border border-red-200 rounded-xl p-6">
            <div className="flex items-center">
              <div className="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                <span className="text-red-600 text-sm">⚠</span>
              </div>
              <div>
                <h3 className="text-lg font-semibold text-red-800">Ошибка анализа</h3>
                <p className="text-red-600 mt-1">{error}</p>
              </div>
            </div>
          </div>
        )}
        
        {/* Structural Analysis */}
        {structuralAnalysis && (
          <div className="mt-6">
            <StructuralAnalysisComponent analysis={structuralAnalysis} />
          </div>
        )}
        
        {/* Results */}
        {contractParagraphs.length > 0 && (
          <div className="mt-6">
            <AnalysisResults
              contractParagraphs={contractParagraphs}
              missingRequirements={missingRequirements}
              ambiguousConditions={ambiguousConditions}
              showCompliance={showCompliance}
              showPartial={showPartial}
              showRisks={showRisks}
              showOther={showOther}
              showMissing={showMissing}
              exportToDocx={() => exportToDocx(contractParagraphs)}
              onUpdateComment={handleUpdateComment}
              onSubmitFeedback={handleSubmitFeedback}
            />
          </div>
        )}

        {/* Examples Section */}
        <div className="mt-16 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-semibold text-gray-900 flex items-center">
              <File className="hf-orange-text mr-2" size={20} />
              Попробуйте пример
            </h3>
          </div>
          <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
            <Button
              onClick={loadExample}
              variant="ghost"
              className="w-full p-4 h-auto text-left hover:bg-white hover:shadow-sm transition-all border border-transparent hover:border-gray-200"
            >
              <div className="flex items-center">
                <div className="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center mr-3">
                  <File className="text-blue-600" size={20} />
                </div>
                <div>
                <div className="font-semibold text-gray-900">Договор поставки</div>
                <div className="text-sm text-gray-600">Стандартный договор поставки товаров</div>
                </div>
              </div>
            </Button>
          </div>
        </div>
      </div>

      {/* Analysis Progress */}
      <AnalysisProgress 
        isAnalyzing={isAnalyzing} 
        onComplete={handleAnalysisComplete}
      />
    </div>
  );
}

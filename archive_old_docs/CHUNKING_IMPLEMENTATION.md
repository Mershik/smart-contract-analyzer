# Реализация чанкинга для анализа прав в Этапе 5

## Проблема
Функция `extractRightsFromClauses` отправляла все 25 приоритетных пунктов в одном запросе к Gemini API, что приводило к:
- Пустым ответам из-за перегрузки модели
- Превышению лимитов токенов
- Нестабильной работе анализа дисбаланса прав

## Решение
Реализован подход с чанкингом (разбивкой на части) для Шага 5.1 - извлечения прав:

### Ключевые изменения:
1. **Размер чанка**: 7 пунктов (оптимальное соотношение скорости и надежности)
2. **Итеративная обработка**: Вместо одного большого запроса - несколько маленьких
3. **Отказоустойчивость**: Если один чанк не удался, остальные продолжают работать
4. **Пауза между запросами**: 1 секунда для соблюдения лимитов API

### Архитектура:
```
Этап 5: Анализ дисбаланса прав
├── Шаг 5.1: extractRightsFromClauses (МОДИФИЦИРОВАН)
│   ├── Чанк 1 (пункты 1-7) → API запрос → права покупателя/поставщика
│   ├── Чанк 2 (пункты 8-14) → API запрос → права покупателя/поставщика  
│   ├── Чанк 3 (пункты 15-21) → API запрос → права покупателя/поставщика
│   └── Чанк 4 (пункты 22-25) → API запрос → права покупателя/поставщика
│   └── Объединение всех результатов
└── Шаг 5.2: analyzeRightsImbalance (БЕЗ ИЗМЕНЕНИЙ)
    └── Анализ собранных прав → дисбалансы
```

### Преимущества:
- ✅ **Надежность**: Вероятность пустых ответов стремится к нулю
- ✅ **Отказоустойчивость**: Система работает даже если 1-2 чанка не удались
- ✅ **Соблюдение лимитов**: Каждый запрос ~2000 токенов вместо 8000+
- ✅ **Качество**: AI лучше обрабатывает небольшие объемы данных
- ✅ **Совместимость**: Шаг 5.2 работает с результатами без изменений

### Производительность:
- **Было**: 1 запрос с высоким риском сбоя
- **Стало**: 4 запроса с высокой надежностью
- **Время**: ~4 секунды (с паузами) вместо потенциальных повторных попыток
- **Токены**: 4 × 2000 = 8000 токенов (распределенно) вместо 8000+ в одном запросе

## Файлы изменены:
- `client/src/lib/gemini.ts` - функция `extractRightsFromClauses`

## Тестирование:
Логика чанкинга протестирована на 25 пунктах:
- Создается 4 чанка по 7, 7, 7, 4 пункта
- Каждый чанк обрабатывается независимо
- Результаты корректно объединяются